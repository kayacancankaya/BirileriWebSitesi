@model BirileriWebSitesi.Models.ViewModels.ProductDetailedViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
@{
    string? userId = string.Empty;
    int index = 0;
    if (User.Identity.IsAuthenticated)
    {
        userId = UserManager.GetUserId(User);
    }
    else
    {
        userId = "0";
    }
    
}
@section Title {
    <meta name="title" content=@Model.Product.MetaTitle>
    <title>@Model.Product.MetaTitle</title>
}
@section Description {
    <meta name="description" content=@Model.Product.MetaDescription>
}
@section Keywords {
    <meta name="keywords" content=@Model.Product.MetaKeywords>
}
@section CSS {
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css" />

<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" />


<style>
        #variant-image .swiper {
            width: 100%;
            max-width: 500px; 
            height: auto;
            position: relative;
        }

        /* Make each image same size */
        #variant-image .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* or 'contain' if you want full image */
            border-radius: 8px;
        }


            /* Adjust swiper navigation buttons inside the boundaries */
            #variant-image .swiper-button-prev,
            #variant-image .swiper-button-next {
                color: #000;
                top: 50%;
                transform: translateY(-50%);
            }

    .product-variants {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f9f9f9;
    }

    .product-variants h5 {
    margin-bottom: 10px;
    font-size: 18px;
    font-weight: bold;
    }

    .variant-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    }

    .variant-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    }

    .variant-title {
    font-weight: bold;
    font-size: 16px;
    }

    .variant-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    }

    .variant-button {
    padding: 6px 12px;
    font-size: 14px;
    border: 1px solid #007bff;
    background: white;
    color: #007bff;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    }

    .variant-button:hover,
    .variant-button.active {
    background: #007bff;
    color: white;
    }

        .post-thumb {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 180px; /* or same as your image height if needed */
        }

</style>
}

<input type="hidden" id="product-code" value="@Model.Product.ProductCode" />
<input type="hidden" id="product-name" value="@Model.Product.ProductName" />
<input type="hidden" id="variant-name" value="" />
<!--Product Container-->
<div class="sidebar-page-container">
    <div class="auto-container">
        <div class="row clearfix">
            <div class="shop-single">
                <div class="product-details">

                    <!--Basic Details-->
                    <div class="basic-details d-flex justify-content-center">
                        <div class="row w-100">
                            <div class="image-column col-lg-6 col-md-12 col-sm-12 " id="variant-image" >
                                @Html.Partial("_PartialProductVariantImage", Model.ProductVariantImage)
                            </div>
                            <div class="info-column col-lg-6 col-md-12 col-sm-12 " >

                                <div class="details-header" id="variant-info">
                                    @Html.Partial("_PartialProductVariantInfo", Model.ProductVariantInfo)
                                </div>
                                <!--variant list-->
                                <div class="product-variants">
                                    <h5>Varyasyonlar</h5>
                                    <div class="variant-container">
                                        @foreach (var globalVariant in Model.GlobalVariants)
                                        {
                                            bool isSelected = false;
                                            string selectedVariantKey = Model.ProductVariantInfo.SelectedVariantAttribute.Substring(index, 6);
                                            
                                            <div class="variant-group" data-global-key="@globalVariant.Key">
                                                <input type="hidden" class="global-variant-key" value="@globalVariant.Key" />
                                                <span class="variant-title">@globalVariant.Value</span>
                                                <div class="variant-options">
                                                    @{
                                                        Dictionary<string,string> variantAttributes = Model.VariantAttributes
                                                        .Where(k => k.Key.StartsWith(globalVariant.Key))
                                                        .ToDictionary(d=>d.Key,d=>d.Value);
                                                    }
                                                    @foreach (var item in variantAttributes)
                                                    {
                                                        if (item.Key == selectedVariantKey)
                                                            isSelected = true;
                                                        
                                                        @if(isSelected)
                                                        {
                                                            <span class="alert-text"></span>
                                                            <button class="variant-button active" data-key="@item.Key" data-value="@item.Value">@item.Value</button>
                                                        }
                                                        else
                                                        {
                                                            <span class="alert-text"></span>
                                                            <button class="variant-button" data-key="@item.Key" data-value="@item.Value">@item.Value</button>
                                                        }
                                                        isSelected = false;   
                                                    }
                                                </div>
                                            </div>
                                            index += 6; // Increment to the next global variant key
                                        }
                                    </div>
                                </div>

                                
                                <div class="other-options clearfix">
                                    @* <div class="item-quantity"><input class="quantity-spinner" type="text" value="1" name="quantity"></div> *@
                                    @if (Model.ProductVariantInfo.Quantity > 0)
                                    {
                                        <span class="alert-text"></span>
                                        <button type="button" class="theme-btn btn-style-one add-to-cart" style="margin-top:20px;">Sepete Ekle</button>
                                    }
                                    else
                                    {
                                        <span class="alert-text"></span>
                                        <button type="button" class="theme-btn btn-style-one add-to-inquiry" style="margin-top:20px;background-color:#08c9c6;">Talep Oluştur</button>
                                    }
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--Basic Details ends-->
                    <!--Product Info Tabs-->
                    <div class="product-info-tabs ml-3">
                        <!--Product Tabs-->
                        <div class="prod-tabs tabs-box">

                            <!--Tab Btns-->
                            <ul class="tab-btns tab-buttons clearfix">
                                <li data-tab="#prod-details" class="tab-btn">AÇIKLAMA</li>
                            </ul>

                            <!--Tabs Container-->
                            <div class="tabs-content" id="prod-details-div">

                                <!--Tab-->
                                <div class="tab" id="prod-details">
                                    <div class="content">
                                        @Model.Product.ProductDescription
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--End Product Info Tabs-->
                </div>
            </div>
        </div>

        <!--Popular Product Div-->
        <div class="row clearfix m-1" id="popular-products-div">
        </div>
        <!--Related Product Div-->
        <div class="row clearfix m-1" id="related-products-div">
        </div>
    </div>
</div>
<input type="hidden" id="currentState" value="0" />
<input type="hidden" class="user-id" value="@userId" />

@section FancyBox {
    <script src="~/js/jquery.fancybox.min.js" defer></script>
}
<!--End Sidebar Page Container-->
@section AdditionalScripts {
    <!-- owl carousel JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>
    <script>
        $(document).ready(function () {

            var currentState = parseInt($('#currentState').val());
            lastWidth = window.innerWidth;
            
            $(".dropdown").removeClass("current");
            $(".shop").addClass("current");
            $("#popular-product-carousel").owlCarousel({
                                loop: true,
                                margin: 20,
                                nav: false,
                                dots: false,
                                autoplay: true,
                                autoplayTimeout: 4000,
                                autoplayHoverPause: true,
                                responsive: {
                                    0: {
                                        items: 1
                                    },
                                    576: {
                                        items: 2
                                    },
                                    768: {
                                        items: 3
                                    },
                                    992: {
                                        items: 4
                                    }
                                },
                            });
            if ($('.quantity-spinner').length) {
                $(".quantity-spinner").TouchSpin({
                    min: 1,
                    max: 100,
                    step: 1,
                    verticalbuttons: true,
                    buttondown_txt: '-',
                    buttonup_txt: '+'
                });
            }
            //description toggler
            $('.tab-btn').on('click', function () {
              var tabId = $(this).data('tab');
              var $tab = $(tabId);

                // If this tab is already active, hide it
                if ($tab.hasClass('active-tab')) {
                    $tab.removeClass('active-tab');
                    $("#prod-details-div").css('display','block');
                } else {
                    $tab.addClass('active-tab');
                    $("#prod-details-div").css('display','none');
                }
            });
            // Swipe pics
            const swiper = new Swiper('.swiper', {
               loop: true,
               lazy: true,
               speed: 400,
               spaceBetween: 100,
               navigation: {
                   nextEl: '.swiper-button-next',
                   prevEl: '.swiper-button-prev',
               },
               pagination: {
                   el: '.swiper-pagination',
                   clickable: true,
               },
            });
            
            var baseProductCode = $("#product-code").val();
            //increase popularity
            $.ajax({
                    type: "POST",
                    headers: { "RequestVerificationToken": getAntiForgeryToken() },
                    async: true,
                    url: "/Shop/IncreasePopularity",
                    data: { baseProductCode: baseProductCode },
                    
                });
            //load more content
            function debounce(func, wait) {
                let timeout;
                return function () {
                    const context = this, args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }
            $(window).scroll(debounce(function () {
                
                var currentHeight = $(window).scrollTop();
                if (currentHeight >= 100 && currentState === 0) {
                    currentState = 1;
                    $('#currentState').val(currentState);
                    $.ajax({
                        type: "GET",
                        url: "/Shop/_PartialPopularProductsWidget",
                        async: true,
                        processData: true,
                        cache: true,
                        success: function (result) {
                            $("#popular-products-div").html(result);
                            $("#popular-product-carousel").owlCarousel({
                                loop: true,
                                margin: 20,
                                nav: false,
                                dots: false,
                                autoplay: true,
                                autoplayTimeout: 4000,
                                autoplayHoverPause: true,
                                responsive: {
                                    0: {
                                        items: 1
                                    },
                                    576: {
                                        items: 2
                                    },
                                    768: {
                                        items: 3
                                    },
                                    992: {
                                        items: 4
                                    }
                                },
                            });
                        }
                    });

                    var productCode = $('#product-code').val();
                    $.ajax({
                        type: "GET",
                        url: "/Shop/_PartialRelatedProductsWidget",
                        async: true,
                        processData: true,
                        cache: true,
                        data: {productCode : productCode},
                        success: function (result) {
                            $("#related-products-div").html(result);
                            $("#related-product-carousel").owlCarousel({
                                loop: true,
                                margin: 20,
                                nav: false,
                                dots: false,
                                autoplay: true,
                                autoplayTimeout: 4000,
                                autoplayHoverPause: true,
                                responsive: {
                                    0: {
                                        items: 1
                                    },
                                    576: {
                                        items: 2
                                    },
                                    768: {
                                        items: 3
                                    },
                                    992: {
                                        items: 4
                                    }
                                },
                            });
                        }
                    });

                }
            }, 100));
            $(document).on("click", ".variant-button", function () {
                var selectedVar = $(this).text().trim();
                // Remove active class from siblings and add it to the clicked button
                $(this).siblings().removeClass("active");
                $(this).addClass("active");
                var button = $(this);
              
                var variantAttributes = {};

                $(".variant-group").each(function () {
                    var globalVariantKey = $(this).find(".variant-button.active").data("key"); 
                    var activeVariant = $(this).find(".variant-button.active").text().trim();

                    if (globalVariantKey && activeVariant) {
                        variantAttributes[globalVariantKey] = activeVariant;
                    }
                });

                var productCode = $("#product-code").val();
                var productName = $("#product-name").val();
                $.ajax({
                    type: "GET",
                    url: "/Shop/GetPartialViewsForProductVariant",
                    async: true,
                    data: {
                        productCode: productCode,
                        productName: productName,
                        variantAttributes: variantAttributes
                    },
                    success: function (response) {
                        $("#variant-image").html(response.imagePartial);  
                        $("#variant-info").html(response.infoPartial);

                        // Swipe pics
                        const swiper = new Swiper('.swiper', {
                           loop: true,
                           lazy: true,
                           speed: 400,
                           spaceBetween: 100,
                           navigation: {
                               nextEl: '.swiper-button-next',
                               prevEl: '.swiper-button-prev',
                           },
                           pagination: {
                               el: '.swiper-pagination',
                               clickable: true,
                           },
                        });
                    },
                    error: function (xhr) {

                    try {
                        // Try parsing JSON response
                        var response = JSON.parse(xhr.responseText);
                        showAlert(button,response.message, "danger");
                    } catch (e) {
                        showAlert(button,"Beklenmeyen Bir Hata Oluştu.Lütfen Tekrar Deneyiniz...", "danger");
                    }
                }

                });
            });

            $(document).on("click", ".add-to-cart", function () {
                var userId = $(this).closest('.clearfix').find('.user-id').val();
                var productCode = $('#variant-code').val();
                var quantity = 1;
                var price = parseFloat($('#variant-price').text());
               
                var button = $(this);
                $.ajax({
                    type: "POST",
                    headers: { "RequestVerificationToken": getAntiForgeryToken() },
                    async: true,
                    url: "/Cart/AddToCart",
                    data: {
                        userId: userId,
                        productCode: productCode,
                        price: price,
                        quantity: quantity
                    },
                    success: function (response) {
                        if(response.success)
                        {
                               showAlert(button, response.message, "success");
                                let currentItem = response.totalProduct;
                                $(".cart .cart-count").text(currentItem);
                        }
                         else{
                            showAlert(button, response.message, "error");
                            let currentItem = response.totalProduct;
                            $(".cart .cart-count").text(currentItem);
                        }
                    },
                    error: function (xhr) {
                        var response = JSON.parse(xhr.responseText);

                        showAlert(button, response.message, "danger");
                    }
                });
            });

            $(document).on("click", ".add-to-inquiry", function () {
                var userId = $(this).closest('.clearfix').find('.user-id').val();
                var productCode = $('#variant-code').val();
                var price = parseFloat($('#variant-price').text());
                int quantity = 1;

                var button = $(this);
                $.ajax({
                    type: "POST",
                    headers: { "RequestVerificationToken": getAntiForgeryToken() },
                    async: true,
                    url: "/Cart/AddToInquiry",
                    data: {
                        userId: userId,
                        productCode: productCode,
                        price: price,
                        quantity: quantity
                    },
                    success: function (response) {
                        if(response.success)
                        {
                               showAlert(button, response.message, "success");
                                let currentItem = response.totalProduct;
                                $(".inquiry .inquiry-count").text(currentItem);
                        }
                         else{
                            showAlert(button, response.message, "error");
                            let currentItem = response.totalProduct;
                            $(".inquiry .inquiry-count").text(currentItem);
                        }
                    },
                    error: function (xhr) {
                        var response = JSON.parse(xhr.responseText);

                        showAlert(button, response.message, "danger");
                    }
                });
            });
        });
         window.addEventListener('resize', () => {
          
                if (Math.abs(lastWidth - window.innerWidth) > 200) {
                    lastWidth = window.innerWidth;
                     $.ajax({
                         type: "GET",
                         url: "/Shop/_PartialPopularProductsWidget",
                         async: true,
                         success: function (result) {
                             $("#popular-products-div").html(result);
                             $("#popular-product-carousel").owlCarousel({
                                 loop: true,
                                 margin: 20,
                                 nav: false,
                                 dots: false,
                                 autoplay: true,
                                 autoplayTimeout: 4000,
                                 autoplayHoverPause: true,
                                 responsive: {
                                     0: {
                                         items: 1
                                     },
                                     576: {
                                         items: 2
                                     },
                                     768: {
                                         items: 3
                                     },
                                     992: {
                                         items: 4
                                     }
                                 },
                             });
                         }
                     });
                     $.ajax({
                         type: "GET",
                         url: "/Shop/_PartialRelatedProductsWidget",
                         async: true,
                         success: function (result) {
                             $("#related-products-div").html(result);
                             $("#related-product-carousel").owlCarousel({
                                 loop: true,
                                 margin: 20,
                                 nav: false,
                                 dots: false,
                                 autoplay: true,
                                 autoplayTimeout: 4000,
                                 autoplayHoverPause: true,
                                 responsive: {
                                     0: {
                                         items: 1
                                     },
                                     576: {
                                         items: 2
                                     },
                                     768: {
                                         items: 3
                                     },
                                     992: {
                                         items: 4
                                     }
                                 },
                             });
                         }
                     });
                 }
          });
    </script>
}
