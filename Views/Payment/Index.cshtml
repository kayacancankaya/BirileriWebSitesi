@model BirileriWebSitesi.Models.PaymentViewModel


@section Title {
    <meta name="title" content="Ödeme">
    <title>Ödeme</title>
}
@section Description {
    <meta name="description" content="İthal ürünleri toptan ve perakende olarak satın alın. Katalog ürünleri, marka patent desteği ve e-ticaret çözümleri sunuyoruz.">
}
@section Keywords {
    <meta name="keywords" content="Çin ithalat, toptan ürünler, perakende satış, marka patent, e-ticaret çözümleri, toptan spor malzemeleri ithalatı, marka desteği, toptan petshop ürünleri,
                                        toptan spor malzemesi">
}

@section CSS {
	<style>
        .exp-date-row {
            display: flex;
            flex-wrap: wrap; /* optional: wrap on small screens */
        }

        .credit-card-info {
            margin-top: 20px;
        }

        .no-arrow::-webkit-outer-spin-button,
        .no-arrow::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-arrow {
            -moz-appearance: textfield;
        }
        .checkout-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .payment-box {
            flex: 1 1 100%;
        }

        .cart-info {
            flex: 1 1 30%;
            border: 1px solid #ccc;
            padding: 15px;
            background: #f9f9f9;
        }

        /* Responsive */
        @@media (min-width: 768px) {
            .payment-box

        {
            flex: 1 1 65%;
        }

        .cart-info {
            flex: 1 1 35%;
        }

        }

        /* Dropdown Styling */
        .info-dropdowns .dropdown-item {
            margin-bottom: 10px;
        }

        .dropdown-toggle {
            width: 100%;
            background: #eee;
            border: none;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            text-align: left;
        }

        .dropdown-checkbox {
            margin-right: 10px; 
            transform: scale(1.2); 
        }

        .dropdown-content {
            display: none;
            background-color: white;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: relative;
            color: #333;
        }

            .dropdown-content.show {
                display: block;
            }

        .dropdown-toggle {
            cursor: pointer;
            background-color: transparent;
            border: none;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

            .dropdown-toggle:hover {
                text-decoration: underline;
            }

        .section {
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            max-width: 100%; 
            word-break: break-word;
        }

	
	 @@media (min-width: 992px) { 
            .credit-card-info {
                margin-top: 20px;
                margin-left: 10px;
            }
        }
    </style>

}

<div class="sidebar-page-conatiner">
    <div class="auto-container">
        <div class="row clearfix">
            <!--Content Side-->
            <div class="content-side col-lg-9 col-md-8 col-sm-12">
                <!--Payment Box-->
                <div class="payment-box">
                    <div class="upper-box">

                        <!--Payment Options-->
                        <div class="payment-options">
                            <ul>
                                <li>
                                    <div class="radio-option">
                                        <input type="radio" name="payment-group" id="payment-2" checked>
                                        <label for="payment-2"><strong>Banka Transferi</strong>
                                            <span class="small-text" id="payment-2-text">
                                                Banka Havalesi ile ödeme yapın. Ödemenizin açıklamalar kısmına sipariş numaranızı eklemenizi önemle rica ederiz.
                                                Ödemeniz bankaya ulaştıktan sonra ürünleriniz kargoya hazırlanacaktır.<br />

                                                <span><strong>Banka Adı:</strong> T. Garanti Bankası A.Ş.</span><br />
                                                <span><strong>Şube:</strong> KARŞIYAKA ÇARŞI </span><br />
                                                <span><strong>Hesap No:</strong> 1596-6298952</span><br />
                                                <span><strong>Alıcı:</strong> BİRİLERİ DIŞ TİCARET DANIŞMANLIK SANAYİ VE TİCARET LİMİTED Ş.</span><br />
                                                <span><strong>IBAN:</strong> TR89 0006 2001 5960 0006 2989 52</span><br />

                                            </span>
                                        </label>
                                    </div>
                                </li>
                                <li>
                                    <div class="radio-option">
                                        <input type="radio" name="payment-group" id="payment-1">
                                        <label for="payment-1"><strong>Kredi Kartı</strong></label>
                                    </div>

                                    <!--Credit Card-->
                                    <div id="credit-card-info" class="credit-card-info" style="display: none;">
                                        <h3>Kredi Kartı Bilgileri</h3>

                                        <!-- Credit Card Fields  -->
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <div class="field-label">Kart Sahibi:</div>
                                            <input type="text" id="card-holder-name" class="no-arrow" style="width:300px;padding-left:5px;" placeholder="Kart Sahibi">
                                        </div>
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <div class="field-label">Kart Numarası:</div>
                                            <input type="number" id="credit-card-number" class="no-arrow pl-1" style="width:300px;padding-left:5px;" placeholder="Kart Numarası">
                                        </div>
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <div class="field-label">Son Kullanma Tarihi:</div>
                                            <div class="exp-date-row">
                                                <input type="number" id="expiry-date-month" style="max-width:30px; max-height:24px;padding-left:5px;" class="pl-1 no-arrow" placeholder="AA">
                                                <p class="ml-2 mr-2" style="justify-content:center;">/</p>
                                                <input type="number" id="expiry-date-year" style="max-width:60px;max-height:24px;padding-left:5px;" class="pl-1 no-arrow" placeholder="YY">
                                            </div>
                                        </div>
                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <div class="field-label">CVV:</div>
                                            <input style="max-width:40px; padding-left:5px;" class="no-arrow" type="number" id="cvv" placeholder="CVV">
                                        </div>
                                        <div id="installment-div" class="form-group col-lg-6 col-md-6 col-sm-12" style="display:none;">
                                            <label for="installment">Taksit Seçeneği:</label>
                                            <select id="installment" name="installment">
                                                <option value="1">Tek Çekim</option>
                                                <option value="2">2 Taksit</option>
                                                <option value="3">3 Taksit</option>
                                            </select>
                                        </div>

                                        <div class="form-group col-lg-6 col-md-6 col-sm-12">
                                            <input type="checkbox" id="3d-payment" value="true" checked>
                                            <label for="3d-payment">3D Secure ile Öde</label>
                                        </div>
                                    </div>

                                </li>

                            </ul>
                        </div>
                    </div>
                    <!--Legal Forms-->
                    <div class="info-dropdowns" style="margin-left:30px;">
                        <div class="dropdown-item">
                             <input type="checkbox" checked class="dropdown-checkbox">
                       
                            <button class="dropdown-toggle">Ön Bilgilendirme Formu</button>
                            <div class="dropdown-content">
                                @Html.Partial("_PartialOnBilgilendirmeFormu", Model)
                                <div class="dropdown-content">
                                    @Html.Partial("_PartialOnBilgilendirmeFormu", Model)
                                </div>
                            </div>
                        </div>
                        <div class="dropdown-item">
                        
                            <input type="checkbox" checked class="dropdown-checkbox">
                            <button class="dropdown-toggle">Mesafeli Satış Sözleşmesi</button>
                            <div class="dropdown-content">
                                @Html.Partial("_PartialMesafeliSatisSozlesmesi", Model)
                            </div>
                        </div>
                        <div class="dropdown-item">
                            <input type="checkbox" checked class="dropdown-checkbox">
                            <button class="dropdown-toggle">KVKK Aydınlatma Metni</button>
                            <div class="dropdown-content">
                                @Html.Partial("_PartialAydinlatmaMetni", Model)
                            </div>
                        </div>
                        <div class="dropdown-item section">
                           <p>Ödemeyi Tamamla tuşuna basarak, Ön Bilgilendirme Formu, Mesafeli Satış Sözleşmesi ve KVKK Aydınlatma metnini okuyup onayladığınız kabul edilir.</p>
                            <p>Ödenecek Toplam Tutar KDV Dahil <span id="info-p-total-amount"> @Model.TotalAmount.ToString("C2") </span></p>
                        </div>
                    </div>
                        <!--End Legal Forms-->
                    <div class="lower-box text-right">
                        <span class="alert-text"></span>
                        <a id="finish-payment" class="theme-btn order-btn">ÖDEMEYİ TAMAMLA</a>
                    </div>
                </div>
                <!--End Payment Box-->
            </div>
            <div class="sidebar-side col-lg-3 col-md-4 col-sm-12">
                <!-- Cart Info Section -->
                <div class="order-box">
                    <h2>Siparişiniz</h2>
                    <div class="title-box clearfix">
                        <div class="col">ÜRÜN</div>
                        <div class="col">TOPLAM</div>
                    </div>
                    <ul>

                        @foreach (var item in Model.OrderItems)
                        {
                            decimal subTotal = item.UnitPrice * item.Units;
                            <li class="clearfix order-item">
                                <input type="hidden" class="product-code" value="@item.ProductCode" />
                                <input type="hidden" class="unit-price" value="@item.UnitPrice" />
                                Ürün Adı:<strong>
                                    <span class="product-name">@item.ProductName </span> / Miktar: <span class="quantity">@item.Units</span>
                                </strong>
                            </li>
                            <li class="clearfix">ALT TOPLAM <span>@subTotal</span></li>
                        }
                        <li class="clearfix">KARGO ÜCRETİ<span class="free">@Model.ShippingCost ₺</span></li>
                        <li class="clearfix">TOPLAM<span id="final-price">@Model.TotalAmount ₺</span></li>
                    </ul>
                </div>
	            <!--End Cart Info Section-->
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="order-id" value="@Model.OrderId" />
<input type="hidden" id="total-amount" value="@Model.TotalAmount" />
<input type="hidden" id="shipping-email-address" value="@Model.ShipToAddress.EmailAddress" />
<input type="hidden" id="billing-email-address" value="@Model.BillingAddress.EmailAddress" />
@section AdditionalScripts {
    <script>
	    $(document).ready(function () {
            //make active related navigation button
            $(".dropdown").removeClass("current");
            $(".cart").addClass("current");

            document.querySelectorAll('.dropdown-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const content = btn.nextElementSibling;
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
            //payment type selection change toggle related
            $(document).on("change", "#payment-1", function () {
                    if (this.checked) {
                        $("#credit-card-info").css("display","block");
                        $("#payment-2-text").css("display","none");
                        $("#info-form-payment-type").text("Kredi Kartı");
                        $("#agreement-form-payment-type").text("Kredi Kartı");
                    } else {
                        $("#is-corporate-div").style.display = 'none';
                        $("#payment-2-text").css("display","block");
                        $("#info-form-payment-type").text("Banka Transferi");
                        $("#agreement-form-payment-type").text("Banka Transferi");
                    }
            });
            //payment type selection change toggle related
            $(document).on("change", "#payment-2", function () {
                if (this.checked) {
                    $("#credit-card-info").css("display","none");
                    $("#payment-2-text").css("display","block");
                        $("#info-form-payment-type").text("Banka Transferi");
                        $("#agreement-form-payment-type").text("Banka Transferi");
                } else {
                    $("#is-corporate-div").style.display = 'block';
                    $("#payment-2-text").css("display","none");
                        $("#info-form-payment-type").text("Kredi Kartı");
                        $("#agreement-form-payment-type").text("Kredi Kartı");
                }
            });
            //validate credit card input
            $(document).on("input","#credit-card-number", function () {
                const cardNumber = $(this).val().replace(/\s+/g, '');
                if (cardNumber.length >= 6) {
                    const binNumber = cardNumber.substring(0, 6);
                    var price = parseFloat($("#total-amount").val());
                    $.ajax({
                        url: "/Payment/CheckInstallment",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({ binNumber: binNumber, price: price }),
                        success: function (response) {

                                if(response.installments.force3Ds === 1){
                                    force3ds = 1;
                                    $("#3d-payment").prop("checked", true);
                                    $("#3d-payment").prop("disabled", true);
                                }
                                else{

                                    force3ds = 0;
                                    $("#3d-payment").prop("checked", false);
                                    $("#3d-payment").prop("disabled",false);
                                };                               

                            if (response.installments && response.installments.installmentPrices.length > 0) {
                                
                                $("#installment").empty();
                                $.each(response.installments.installmentPrices, function (i, item) {

                                    $("#installment").append(
                                        `<option value="${item.installmentNumber}"
                                        data-price="${item.price}"
                                        data-total-price="${item.totalPrice}">  ${item.installmentNumber} Taksit - Ayda ${parseFloat(item.price).toFixed(2)}₺ - Toplam ${parseFloat(item.totalPrice).toFixed(2)}₺ </option>`
                                    );
                                });
                                $("#installment-div").show();
                            } else {

                                $("#installment-div").hide();
                            }
                        },
                        error: function () {

                            $("#installment-div").hide();
                        }
                    });
                } else {
                    $("#installment-div").hide();
                }
            });
            //calculate price iaw installment choice
            $(document).on("change","#installment", function() {
                var selectedOption = $(this).find("option:selected");
                var installmentNumber = selectedOption.val();
                var installmentPrice = selectedOption.data("price");
                var totalPrice = selectedOption.data("total-price");

                $("#installment").val(installmentNumber);
                $("#installment").attr("data-price", installmentPrice);
                $("#installment").attr("data-total-price", totalPrice);
                $("#agreement-form-installment-amount").text(installmentNumber);
                $("#agreement-form-total-amount").text(totalPrice);
                $("#info-form-installment-amount").text(installmentNumber);
                $("#info-form-total-amount").text(totalPrice);
                $("#total-amount").val(totalPrice);
                $("#info-p-total-amount").text(totalPrice);
                $("#final-price").text(totalPrice);
            });
            //finish payment
            $(document).on("click", "#finish-payment", function (e) {

                    e.preventDefault();
                    var button = $(this);
                    // Disable button and show loading
                    $("#finish-payment").text("İşlem Yapılıyor...").prop("disabled", true);
                    let requiredFields = [];
                
                    var isCreditCardPayment = $("#payment-1").is(":checked");
                    var force3Ds = $("#3d-payment").is(":checked");
                    if(isCreditCardPayment)
                    {
                        requiredFields.push("credit-card-number", "expiry-date-month", "expiry-date-year", "cvv", "card-holder-name");
                        var cardHolderName = $("#card-holder-name").val();
                        var creditCardNumber = $("#credit-card-number").val();
                        var expiryMonth = $("#expiry-date-month").val() ;
                        var expiryYear = $("#expiry-date-year").val();
                        var cvv = $("#cvv").val();
                    }
                    let isValid = true;

                    // if fields are filled
                    requiredFields.forEach(function (id) {
                        let input = document.getElementById(id);
                        if (input && input.value.trim() === "") {
                            isValid = false;
                            input.style.border = "1px solid red"; // Highlight empty fields
                        } else {
                            input.style.border = ""; // Reset style
                        }
                    });
                    if (!isValid) {
                        e.preventDefault();
                        showAlert(button,"Lütfen zorunlu alanları doldurun.","danger");
                        return;
                    }
                    var paymentType = 0;
                    // Check card payment
                    if(isCreditCardPayment)
                    {
                        paymentType = 1;
                        if (!isValidCardNumber(creditCardNumber)) {
                            e.preventDefault();
                            showAlert(button,"Geçersiz kart numarası.","danger");
                            return;
                        }

                        if (!isValidExpiry(expiryMonth, expiryYear)) {
                            e.preventDefault();
                            showAlert(button,"Geçersiz son kullanma tarihi.","danger");
                            return;
                        }

                        if (!isValidCVV(cvv)) {
                            e.preventDefault();
                            showAlert(button,"Geçersiz CVV.","danger");
                            return;
                        }
                    }
                    else {
                        paymentType = 2;
                    }
		   
		            let emailAddress = $("#billing-email-address").val() || $("#shipping-email-address").val() || "";

                    // Check forms are checked
                    $(".dropdown-checkbox").each(function () {
                        if (!$(this).is(":checked")) {
                            isValid = false;
                            $(this).css("border", "1px solid red");
                        } else {
                            $(this).css("border", "none");
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        showAlert(button, "Lütfen tüm formları okuyup onaylayınız.", "danger");
                        return;
                    }

                    var orderId = parseInt($("#order-id").val());
                    var installmentAmount = parseInt($("#installment").val());
                    var data = {
                        OrderId : orderId,
                        InstallmentAmount: installmentAmount,
                        PaymentType: paymentType,
                        CardHolderName : cardHolderName,
					    CreditCardNumber: creditCardNumber,
                        ExpMonth: expiryMonth,
                        ExpYear: expiryYear,
					    CVV: cvv,
                        RegistrationDate: new Date(),
                        LastLoginDate: new Date(),
                        Ip: "",
                        City: "",
                        Country: "",
                        Force3Ds:force3Ds,
			            EmailAddress: emailAddress,
                    };

                    // Send AJAX request
                    $.ajax({
                        url: "/Payment/PlaceOrder",
                        type: "POST",
                        contentType: "application/json",
                        dataType: "JSON",
                        async: true,
                        data: JSON.stringify(data),

                        headers: { "RequestVerificationToken": getAntiForgeryToken() },
                        success: function (response) {
                            if (response.success) {
                                 // Check if it's a 3DS payment
                                if (response.is3Ds && response.htmlContent) {

                                        const win = window.open('', '_self'); // or '_blank' for new tab
                                        win.document.open();
                                        win.document.write(response.htmlContent);
                                        win.document.close();

                                } else {
                                    if (paymentType === 1) {
					 window.location.href = "/Payment/RedirectWithSuccess?paymentType=1";
				    }
				    else{
					window.location.href = "/Payment/RedirectWithSuccess?paymentType=2";
				   }
                                }
                            } else {

                                showAlert(button, response.message, "error");
                                $("#finish-payment").text("Ödemeyi Tamamla").prop("disabled", false);
                            }
                        },
                        error: function (response) {
                            showAlert(button, response.message, "error");
                            $("#finish-payment").text("Ödemeyi Tamamla").prop("disabled", false);
                        }
                    });
                });
        });
            function isValidCardNumber(number) {
                let sum = 0;
                let shouldDouble = false;
                for (let i = number.length - 1; i >= 0; i--) {
                    let digit = parseInt(number.charAt(i));

                    if (shouldDouble) {
                        digit *= 2;
                        if (digit > 9) digit -= 9;
                    }

                    sum += digit;
                    shouldDouble = !shouldDouble;
                }
                return sum % 10 === 0;
            }
            function isValidExpiry(month, year) {
                if (month < 1 || month > 12) return false;

                const now = new Date();
                const inputMonth = parseInt(month);
                const inputYear = parseInt(`20${year.length === 2 ? year : year.slice(-2)}`);

                const expiryDate = new Date(inputYear, inputMonth, 0);
                if(expiryDate< now) return false;
                return true;
            }
            function isValidCVV(cvv) {
                return /^\d{3,4}$/.test(cvv);
            }
    </script>
}
